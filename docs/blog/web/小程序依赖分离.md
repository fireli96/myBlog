---
meta:
    - title: 小程序依赖分离
      time: 2021-07-15 16:50:44
      tag: 微信小程序
---

# 小程序依赖分离

## 分包独有依赖

**对于所有组件（公共函数）**，即使有些只被一个分包引用，但考虑到将来可能会在其他分包使用，**都应该放入到主包统一管理，分包只维持少量独有依赖**。

这样做的目的是让这些组件（公共函数）能够快速被各个分包使用，因为小程序中分包之间不能互相引用代码。

<!-- more -->

但这样做会让主包过于沉重，而分包又会显得太过轻巧。这时候就需要借助构建工具进行**依赖分离**，将只被分包引用的依赖（`npm` 依赖也一样）打包到分包中。

一些小程序框架支持**依赖分离**，例如：`taro`, `uni-app`。

**[wxa 小程序框架](https://webank.gitee.io/wxa/learn/guide/)，现在也支持本地文件和 `npm` 文件依赖分离，并能根据依赖大小和被分包引用次数作自定义配置。**

<!-- 在实际开发时，如果写了一个只是在某个分包内使用公共函数或是组件，一般来说，我们都会将它放入到分包里：

```
── src
    ── subPackageA
        ── component
        ── pageA
        ── pageB
```

`subPackageA` 是一个分包，`component` 是新添加的组件，被 `pageA` 和 `pageB` 使用。一般来说不会将 `component` 放入到主包中去，因为这个组件只被分包 `subPackageA` 引入，而放入主包会增大主包体积。

在下一次的需求时，另一个分包 `subPackageB` 内又会使用到 `component` 组件，**并且会做一些修改**，由于时间问题、开发人员偷懒、或者不想放入主包增加主包体积，有时会直接将 `component` 组件复制一份到 `subPackageB` 后再作修改。这样两个分包内维护了两个类似的组件。

继续下去，更多的组件发生了上述情况，最终项目中可能会在多个分包内有很多非常类似的组件，这时候，无论是将这些组件移动到主包还是添加一个公共的新功能，都会非常麻烦。在多人协作或是有新人接手的时候，想要维护这样的代码也很头疼。

所以这里必须要有一个规范：**对于公共组件（函数），在不确定一定只被当前分包引用的情况下，都应该放到主包**。

这样当其他分包（主包）需要使用时，直接使用（对应修改）即可。 -->

## 分包异步化

将组件（公共函数）都放入主包是因为分包之间代码不能互相引用。而微信小程序新出的特性[分包异步化](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/async.html)，使开发者能跨分包异步引用代码。

有了这个特性，可以用一个 `公共分包` 来存放公共组件（函数），当需要的时候，其他分包直接使用这个 `公共分包` 的代码。

但对于 `npm` 的依赖依旧可以使用依赖分离的思想，将分包独有依赖打包到分包中。

目前，[分包异步化](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/async.html)只是一个实验中的特性。
