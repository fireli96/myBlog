# 浏览器

## 缓存

浏览器中的缓存位置一共有四种，按优先级从高到低排列分别是：

1. Service Worker，作用离线缓存、消息推送和网络代理
2. Memory Cache
3. Disk Cache
4. Push Cache

## 本地存储

Cookie：向同一个域名下发送请求，都会携带相同的 Cookie

1. 容量缺陷。Cookie 的体积上限只有 4KB，只能用来存储少量的信息。
2. 性能缺陷。Cookie 紧跟域名，不管域名下面的某一个地址需不需要这个 Cookie 。
3. 安全缺陷。能在传输过程中被劫取，被 JS 读取。HttpOnly ture 无法被 JS 读取。

localStorage ：同源，可持久缓存，大小为 5MB。应用，存储一些较稳定不变的数据资源，例如：用户信息，一些 logo 图片。

sessionStorage ：和 localStorage 一致，但只是会话级别，标签页被关闭就消失了。应用，用于存储本次会话期间内的数据，例如：表单，浏览记录等。

IndexedDB: 运行在浏览器中的非关系型数据库, 本质上是数据库。

## 说一说从输入 URL 到页面呈现发生了什么？

1. DNS 解析。查询路径？本地->根->顶级域名；迭代和递归？；缓存？浏览器，系统，路由器，各域名服务器
2. TCP 连接。三次握手，四次挥手，为什么？TCP 特性，面向连接，可靠性，基于字节流？TCP 流量控制，拥塞控制？
3. http 请求。http 特点，无连接，无状态，指定格式传输任何数据？状态码和缓存？1.0 2.0 3.0？
4. 服务器收到请求并给予响应，返回请求的数据
5. 浏览器拿到数据并进行解析、渲染

浏览器解析渲染：

1. 解析 HTML 形成 DOM 树
2. 解析 CSS 形成 CSSOM 树
3. 合并 DOM 树和 CSSOM 树形成布局树
4. 浏览器开始渲染并绘制页面

浏览器渲染优化：

1. 回流：DOM 结构的修改引发 DOM 几何尺寸变化的时候，会发生回流的过程。

    样式计算 -> 布局 —> 绘制 -> 合成

2. 重绘：当 DOM 的修改导致了样式的变化，并且没有影响几何属性的时候，会导致重绘(repaint)。

    没有布局过程

GPU 加速：

满足某些特殊条件的渲染层，会被浏览器自动提升为合成层：

-   根元素 document
-   3D transforms：translate3d、translateZ 等
-   video、canvas、iframe 等元素
-   通过 Element.animate() 实现的 opacity 动画转换
-   position: fixed
-   具有 will-change 属性
-   对 opacity、transform、fliter、backdropfilter 应用了 animation 或者 transition

其他渲染层共用一个合成层。合成层才会输出位图，故合成层变化，不影响其他层级绘制，只会绘制该合成层。同时合成层的 3d 转换直接交给 GPU 处理，无需占用主线程。

## 浏览器安全

### XSS

XSS（cross-site scripting）跨域脚本攻击，指浏览器中执行恶意脚本(无论是跨域还是同域)，从而拿到用户的信息并进行操作

#### 攻击原理

XSS 攻击的实现有三种方式——存储型、反射型和文档型。存储型的

**存储型：**脚本存储到了服务端的数据库，然后返回给其他用户的客户端从而执行这些脚本。例如：那评论内容存到了数据库，在其他人加载评论内容过程时服务端返回直接执行。

**反射型：**指的是恶意脚本作为网络请求的一部分。和存储型不同的是，不需要服务端数据库存储，服务端拿到了这些恶意脚本，没有任何过滤就直接返回。这样，就可以构建恶意链接，诱导他人点击，当他人点击跳转后，服务器返回链接中的恶意代码执行，从而拿到 cookie 这些。通常出现在：网站的搜索栏、用户登录口等地方。

**文档型：**文档型的 XSS 攻击并不会经过服务端，而是作为中间人的角色，在数据传输过程劫持到网络数据包，然后修改里面的 html 文档。

#### 防御措施

不要相信任何用户的输入。前端和后端都需要对用户输入的内容做转码，包括 url 参数。

利用 Cookie 的 HttpOnly 属性。

CSP （内容安全策略）：以可信白名单作机制，来限制网站是否可以包含某些来源内容。默认配置下不允许执行内联代码（`<script>`块内容，内联事件，内联样式），以及禁止执行 eval() , new Function() 等。

1. HTML：对以下这些字符进行转义：

    ```
    &：&amp;
    <：&alt;
    >：&gt;
    '：&#x27;
    "：&quot;
    /：&#x2F;
    ```

2. Javascript：把所有非字母、数字的字符都转义成小于 256 的 ASCII 字符；
3. URL：使用 Javascript 的 encodeURIComponent()方法对用户的输入进行编码，该方法会编码如下字符：`, / ? : @ & = + \$ #`

### CSRF

CSRF（Cross-site request forgery）跨站请求伪造。利用了请求域名时会自动带上域名下的 `cookie` 信息。

#### 攻击原理

和 XSS 攻击对比，CSRF 攻击并不需要将恶意代码注入用户当前页面的 html 文档中，而是诱导进入黑客的网站，进入页面后自动发送其他域名请求，就会带上对应域名 cookie，冒充用户进行操作。

例如：某个论坛的图片链接。黑客分享出来的网站地址。

#### 防御措施

1. Token 验证
2. Referer 验证（简单易行，但 referer 可能被改变）
   HTTP 协议，在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址，在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站
3. Cookie 的 SameSite 属性，同域名下的请求才会附带 Cookie
